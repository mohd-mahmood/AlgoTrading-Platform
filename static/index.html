<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoTrading Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white min-h-screen">
    <div id="root" class="p-6 max-w-7xl mx-auto">
        <div class="text-center py-20">
            <div class="text-6xl mb-4">🔄</div>
            <h2 class="text-2xl font-bold">Loading AlgoTrading Platform...</h2>
        </div>
    </div>

    <script>
        const socket = io();
        
        const app = {
            state: {
                activeMode: 'paper',
                isRunning: false,
                orders: [],
                pnl: { realized: 0, unrealized: 0, total: 0 },
                logs: [],
                strategyLoaded: false,
                strategyName: '',
                showSettings: false,
                config: {
                    angelone_api_key: '',
                    angelone_client_id: '',
                    angelone_password: '',
                    dhan_client_id: '',
                    dhan_access_token: ''
                }
            },

            init() {
                console.log('Initializing app...');
                this.render();
                this.setupSocketListeners();
                this.addLog('System initialized', 'success');
            },

            setupSocketListeners() {
                socket.on('connect', () => {
                    console.log('Socket connected');
                    this.addLog('Connected to server', 'success');
                });

                socket.on('log', (log) => {
                    this.state.logs.push(log);
                    if (this.state.logs.length > 100) this.state.logs.shift();
                    this.updateLogs();
                });

                socket.on('order_update', (order) => {
                    this.state.orders.push(order);
                    this.updateOrders();
                    this.addLog(`Order ${order.side}: ${order.symbol} x ${order.quantity}`, 'info');
                });

                socket.on('disconnect', () => {
                    console.log('Socket disconnected');
                    this.addLog('Disconnected from server', 'warning');
                });
            },

            async switchMode(mode) {
                this.state.activeMode = mode;
                this.addLog(`Switched to ${mode.toUpperCase()} mode`, 'info');
                this.render();
            },

            async uploadStrategy(e) {
                const file = e.target.files[0];
                if (!file || !file.name.endsWith('.py')) {
                    this.addLog('Please upload a valid Python (.py) file', 'error');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/api/strategy/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.state.strategyLoaded = true;
                        this.state.strategyName = data.filename;
                        this.addLog(`Strategy loaded: ${data.filename}`, 'success');
                        this.render();
                    } else {
                        this.addLog(`Strategy load failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    this.addLog(`Upload error: ${error.message}`, 'error');
                }
            },

            async startTrading() {
                if (!this.state.strategyLoaded) {
                    this.addLog('Please load a strategy first', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/trading/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: this.state.activeMode })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.state.isRunning = true;
                        this.addLog(`${this.state.activeMode.toUpperCase()} trading started`, 'success');
                        this.render();
                    } else {
                        this.addLog(`Start failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    this.addLog(`Start error: ${error.message}`, 'error');
                }
            },

            async stopTrading() {
                try {
                    const response = await fetch('/api/trading/stop', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.state.isRunning = false;
                        this.addLog('Trading stopped', 'warning');
                        this.render();
                    }
                } catch (error) {
                    this.addLog(`Stop failed: ${error.message}`, 'error');
                }
            },

            showSettings() {
                this.state.showSettings = true;
                this.render();
            },

            hideSettings() {
                this.state.showSettings = false;
                this.render();
            },

            async saveConfig() {
                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.state.config)
                    });
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        this.addLog('API configuration saved', 'success');
                        this.hideSettings();
                    } else {
                        this.addLog(`Config failed: ${data.message}`, 'error');
                    }
                } catch (error) {
                    this.addLog(`Config error: ${error.message}`, 'error');
                }
            },

            updateConfig(field, value) {
                const keys = field.split('.');
                let obj = this.state;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            },

            addLog(message, type = 'info') {
                const log = {
                    timestamp: new Date().toLocaleTimeString(),
                    message,
                    type
                };
                this.state.logs.push(log);
                if (this.state.logs.length > 100) this.state.logs.shift();
                this.updateLogs();
            },

            updateLogs() {
                const logsEl = document.getElementById('logs-container');
                if (logsEl) {
                    logsEl.innerHTML = this.state.logs.map(log => `
                        <div class="${log.type === 'error' ? 'text-red-400' : 
                                      log.type === 'success' ? 'text-green-400' : 
                                      log.type === 'warning' ? 'text-yellow-400' : 
                                      'text-gray-300'} mb-1">
                            <span class="text-gray-500">[${log.timestamp}]</span> ${log.message}
                        </div>
                    `).join('');
                    logsEl.scrollTop = logsEl.scrollHeight;
                }
            },

            updateOrders() {
                const ordersEl = document.getElementById('orders-tbody');
                if (ordersEl) {
                    const ordersHtml = this.state.orders.slice(-10).reverse().map(order => `
                        <tr class="border-b border-gray-700">
                            <td class="py-3 px-2 text-sm">${new Date(order.timestamp).toLocaleTimeString()}</td>
                            <td class="py-3 px-2 font-semibold">${order.symbol}</td>
                            <td class="py-3 px-2 ${order.side === 'BUY' ? 'text-green-400' : 'text-red-400'}">${order.side}</td>
                            <td class="py-3 px-2">${order.quantity}</td>
                            <td class="py-3 px-2">${order.order_type}</td>
                            <td class="py-3 px-2">${order.executed_price || '-'}</td>
                            <td class="py-3 px-2">
                                <span class="px-2 py-1 rounded text-xs ${order.status === 'EXECUTED' ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}">
                                    ${order.status}
                                </span>
                            </td>
                            <td class="py-3 px-2">
                                <span class="px-2 py-1 rounded text-xs ${
                                    order.mode === 'live' ? 'bg-red-900 text-red-300' : 
                                    order.mode === 'paper' ? 'bg-blue-900 text-blue-300' : 
                                    'bg-purple-900 text-purple-300'}">
                                    ${order.mode.toUpperCase()}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                    
                    ordersEl.innerHTML = ordersHtml || '<tr><td colspan="8" class="py-8 text-center text-gray-500">No orders yet</td></tr>';
                }
            },

            render() {
                const { activeMode, isRunning, strategyLoaded, strategyName, pnl, showSettings, config } = this.state;
                
                document.getElementById('root').innerHTML = `
                    <div>
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                                AlgoTrading Platform
                            </h1>
                            <button onclick="app.showSettings()" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">
                                ⚙️
                            </button>
                        </div>

                        <!-- Mode Switcher -->
                        <div class="flex gap-2 mb-6">
                            <button onclick="app.switchMode('paper')" class="px-6 py-3 rounded-lg font-semibold transition-all ${activeMode === 'paper' ? 'bg-blue-500 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                📈 Paper Trading
                            </button>
                            <button onclick="app.switchMode('backtest')" class="px-6 py-3 rounded-lg font-semibold transition-all ${activeMode === 'backtest' ? 'bg-purple-500 text-white shadow-lg' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                📊 Backtest
                            </button>
                            <button onclick="app.switchMode('live')" class="px-6 py-3 rounded-lg font-semibold transition-all ${activeMode === 'live' ? 'bg-red-500 text-white shadow-lg animate-pulse' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}">
                                💰 Live Trading
                            </button>
                        </div>

                        <!-- Main Controls -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- Strategy Upload -->
                            <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
                                <h3 class="text-xl font-semibold mb-4">Strategy</h3>
                                <label class="flex flex-col items-center justify-center h-32 border-2 border-dashed border-gray-600 rounded-lg cursor-pointer hover:border-blue-500 transition-colors">
                                    <span class="text-4xl mb-2">📤</span>
                                    <span class="text-sm text-gray-400">Upload Python Strategy</span>
                                    <input type="file" accept=".py" onchange="app.uploadStrategy(event)" class="hidden">
                                </label>
                                ${strategyLoaded ? `
                                    <div class="mt-3 p-2 bg-green-900 bg-opacity-30 border border-green-600 rounded text-sm">
                                        ✓ ${strategyName}
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Trading Controls -->
                            <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
                                <h3 class="text-xl font-semibold mb-4">Controls</h3>
                                <div class="space-y-3">
                                    <button onclick="app.startTrading()" ${isRunning ? 'disabled' : ''} 
                                        class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 rounded-lg font-semibold transition-colors">
                                        ▶️ Start Trading
                                    </button>
                                    <button onclick="app.stopTrading()" ${!isRunning ? 'disabled' : ''} 
                                        class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white py-3 rounded-lg font-semibold transition-colors">
                                        ⏸️ Stop Trading
                                    </button>
                                </div>
                                ${isRunning ? '<div class="mt-3 flex items-center justify-center text-green-400">🔄 Running...</div>' : ''}
                            </div>

                            <!-- P&L Display -->
                            <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
                                <h3 class="text-xl font-semibold mb-4">P&L Summary</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Realized:</span>
                                        <span class="${pnl.realized >= 0 ? 'text-green-400' : 'text-red-400'}">
                                            ₹${pnl.realized.toFixed(2)}
                                        </span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Unrealized:</span>
                                        <span class="${pnl.unrealized >= 0 ? 'text-green-400' : 'text-red-400'}">
                                            ₹${pnl.unrealized.toFixed(2)}
                                        </span>
                                    </div>
                                    <div class="flex justify-between pt-2 border-t border-gray-700">
                                        <span class="font-semibold">Total P&L:</span>
                                        <span class="font-bold ${pnl.total >= 0 ? 'text-green-400' : 'text-red-400'}">
                                            ₹${pnl.total.toFixed(2)}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Orders Table -->
                        <div class="bg-gray-800 rounded-lg p-6 shadow-xl mb-6">
                            <h3 class="text-xl font-semibold mb-4">Orders</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="text-left border-b border-gray-700">
                                            <th class="pb-3 px-2">Time</th>
                                            <th class="pb-3 px-2">Symbol</th>
                                            <th class="pb-3 px-2">Side</th>
                                            <th class="pb-3 px-2">Qty</th>
                                            <th class="pb-3 px-2">Type</th>
                                            <th class="pb-3 px-2">Price</th>
                                            <th class="pb-3 px-2">Status</th>
                                            <th class="pb-3 px-2">Mode</th>
                                        </tr>
                                    </thead>
                                    <tbody id="orders-tbody">
                                        <tr><td colspan="8" class="py-8 text-center text-gray-500">No orders yet</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Logs Panel -->
                        <div class="bg-gray-800 rounded-lg p-6 shadow-xl">
                            <h3 class="text-xl font-semibold mb-4">System Logs</h3>
                            <div id="logs-container" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto font-mono text-sm">
                                <div class="text-gray-500">System ready. Load a strategy to begin.</div>
                            </div>
                        </div>

                        <!-- Settings Modal -->
                        ${showSettings ? `
                            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                                    <h2 class="text-2xl font-bold mb-4">API Configuration</h2>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-blue-400 mb-2">AngelOne API</h3>
                                            <input type="text" placeholder="API Key" value="${config.angelone_api_key}"
                                                onchange="app.updateConfig('config.angelone_api_key', this.value)"
                                                class="w-full p-2 bg-gray-700 text-white rounded mb-2">
                                            <input type="text" placeholder="Client ID" value="${config.angelone_client_id}"
                                                onchange="app.updateConfig('config.angelone_client_id', this.value)"
                                                class="w-full p-2 bg-gray-700 text-white rounded mb-2">
                                            <input type="password" placeholder="Password" value="${config.angelone_password}"
                                                onchange="app.updateConfig('config.angelone_password', this.value)"
                                                class="w-full p-2 bg-gray-700 text-white rounded">
                                        </div>

                                        <div>
                                            <h3 class="text-lg font-semibold text-red-400 mb-2">Dhan API (Live Trading)</h3>
                                            <input type="text" placeholder="Client ID" value="${config.dhan_client_id}"
                                                onchange="app.updateConfig('config.dhan_client_id', this.value)"
                                                class="w-full p-2 bg-gray-700 text-white rounded mb-2">
                                            <input type="text" placeholder="Access Token" value="${config.dhan_access_token}"
                                                onchange="app.updateConfig('config.dhan_access_token', this.value)"
                                                class="w-full p-2 bg-gray-700 text-white rounded">
                                        </div>
                                    </div>

                                    <div class="flex gap-3 mt-6">
                                        <button onclick="app.saveConfig()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold">
                                            Save Configuration
                                        </button>
                                        <button onclick="app.hideSettings()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-semibold">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        };

        // Initialize app on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            app.init();
        });
    </script>
</body>
</html>